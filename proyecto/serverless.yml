service: sistema-gestion-espacios

frameworkVersion: '4'

custom:
  configValidationMode: warn
  
  # === FRONTEND DEPLOYMENT CONFIGURATION ===
  client:
    bucketName: ${self:service}-frontend-${self:provider.stage}
    distributionFolder: ${env:FRONTEND_DIST_FOLDER, '../frontend/out'}
    indexDocument: ${env:INDEX_DOCUMENT, 'index.html'}
    errorDocument: ${env:ERROR_DOCUMENT, '404.html'}
    region: ${self:provider.region}
    acl: ${env:S3_ACL, 'public-read'}
    createDistribution: ${env:CREATE_CLOUDFRONT_DISTRIBUTION, 'true'} # CAMBIAR A "false" SI NO TIENE PERMISO PARA CREAR CLOUDFRONT
    manageResources: ${env:MANAGE_S3_RESOURCES, 'true'}
    uploadConcurrency: ${env:UPLOAD_CONCURRENCY, '5'}
  
  # === SPLIT STACKS FOR LARGE DEPLOYMENTS ===
  splitStacks:
    nested: ${env:SPLIT_STACKS_NESTED, 'true'}
    perFunction: ${env:SPLIT_STACKS_PER_FUNCTION, 'false'}
    perType: ${env:SPLIT_STACKS_PER_TYPE, 'true'}
    stackType:
      AWS::ApiGatewayV2::Api: ${env:SPLIT_STACKS_API_GATEWAY, 'false'}
      AWS::ApiGatewayV2::Stage: ${env:SPLIT_STACKS_API_STAGE, 'false'}
      AWS::CloudFormation::Stack: ${env:SPLIT_STACKS_CLOUDFORMATION, 'false'}
  
  # === ENVIRONMENT-SPECIFIC SETTINGS ===
  stages:
    dev:
      logLevel: ${env:LOG_LEVEL_DEV, 'INFO'}
      tracing: ${env:TRACING_DEV, 'false'}
      memorySize: ${env:MEMORY_SIZE_DEV, '256'}
      nodeEnv: ${env:NODE_ENV_DEV, 'development'}
    staging:
      logLevel: ${env:LOG_LEVEL_STAGING, 'WARN'}
      tracing: ${env:TRACING_STAGING, 'true'}
      memorySize: ${env:MEMORY_SIZE_STAGING, '512'}
      nodeEnv: ${env:NODE_ENV_STAGING, 'staging'}
    prod:
      logLevel: ${env:LOG_LEVEL_PROD, 'ERROR'}
      tracing: ${env:TRACING_PROD, 'true'}
      memorySize: ${env:MEMORY_SIZE_PROD, '1024'}
      nodeEnv: ${env:NODE_ENV_PROD, 'production'}
  
  # === AUTOMATION HOOKS ===
  scriptable:
    hooks:
      # PRE-DEPLOYMENT: Setup infrastructure (comment out if AWS credentials not available)
      # before:aws:deploy:deploy:createStack:
      #   - echo "==> Deploying base infrastructure..."
      #   - node ../infrastructure/deploy-infrastructure.js ${self:provider.stage}
      
      # POST-DEPLOYMENT: Frontend build, upload and seeding
      after:deploy:deploy:
        - echo "==> Preparing frontend..."
        - cd ../frontend && npm ci
        - STACK_NAME=${self:service}-${self:provider.stage}; API_URL=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='FrontendApiUrl'].OutputValue" --output text 2>/dev/null); WS_URL=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='FrontendWebSocketUrl'].OutputValue" --output text 2>/dev/null); cd ../frontend && printf "NEXT_PUBLIC_API_URL=%s\nNEXT_PUBLIC_WS_URL=%s\nNEXT_PUBLIC_STAGE=%s\nNEXT_PUBLIC_AWS_REGION=%s\n" "$API_URL" "$WS_URL" "${self:provider.stage}" "${self:provider.region}" > .env.production.local
        - cd ../frontend && npm run build
        - cd ../frontend && npm run export
        - echo "==> Uploading frontend to S3..."
        - npx serverless client deploy
        - echo "==> Seeding database..."
        - DYNAMODB_TABLE=${self:service}-${self:provider.stage}-main node scripts/seed-dynamodb.js --stage ${self:provider.stage} --yes
        - echo "==> Running chaos engineering smoke tests..."
        - cd ../chaos-engineering && npm ci && npm run smoke
      
      # CLEANUP
      before:remove:remove:
        - echo "==> Removing frontend assets..."
        - npx serverless client remove

plugins:
  - serverless-finch
  - serverless-plugin-split-stacks
  - serverless-scriptable-plugin

provider:
  name: aws
  runtime: ${env:NODE_RUNTIME, 'nodejs22.x'}
  region: ${opt:region, env:AWS_REGION, 'us-east-1'}
  stage: ${opt:stage, env:STAGE, 'dev'}
  # Use existing IAM role to avoid permission issues in voclabs
  #iam:
  #  role: arn:aws:iam::${env:AWS_ACCOUNT_ID, '975050051149'}:role/${env:IAM_ROLE_NAME, 'LabRole'}
  deploymentBucket:
    name: ${self:service}-${self:provider.stage}-deployment-v2
    serverSideEncryption: ${env:DEPLOYMENT_BUCKET_ENCRYPTION, 'AES256'}
  # X-Ray tracing configuration (enabled for staging and prod)
  tracing:
    lambda: ${self:custom.stages.${self:provider.stage}.tracing}
  httpApi:
    authorizers:
      cognitoJwt:
        type: jwt
        identitySource: '$request.header.Authorization'
        issuerUrl:
          Fn::Sub: https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}
        audience:
          - { Ref: CognitoUserPoolClient }
  environment:
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: ${env:AWS_NODEJS_CONNECTION_REUSE_ENABLED, '1'}
    AWS_REGION: ${self:provider.region}
    REGION: ${self:provider.region}
    STAGE: ${self:provider.stage}
    NODE_ENV: ${self:custom.stages.${self:provider.stage}.nodeEnv}
    DYNAMODB_TABLE: ${self:service}-${self:provider.stage}-main
    MAIN_TABLE: ${self:service}-${self:provider.stage}-main
    CONNECTIONS_TABLE: ${self:service}-${self:provider.stage}-connections
    CIRCUIT_STATE_TABLE: ${self:service}-${self:provider.stage}-circuit-state
    IDEMPOTENCY_TABLE: ${self:service}-${self:provider.stage}-idempotency
    HTTP_API_URL:
      Fn::Sub: "https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com"
    WEBSOCKET_ENDPOINT:
      Fn::Sub: "https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${self:provider.stage}"
    # SSM parameter name for chaos configuration (used by chaos middleware)
    CHAOS_SSM_PARAM: "/proyecto-grupo-7/${self:provider.stage}/chaos"
    MAIN_QUEUE_URL:
      Ref: MainQueue
    SNS_TOPIC_ARN:
      Ref: SpaceNotificationsTopic
    SNS_ALERTS_TOPIC_ARN:
      Ref: SystemAlertsTopic
    SNS_ADMIN_TOPIC_ARN:
      Ref: AdminNotificationsTopic
    SYSTEM_ALERTS_TOPIC:
      Ref: SystemAlertsTopic
    SNS_PERSONALIZATION_TOPIC_ARN: ${env:SNS_PERSONALIZATION_TOPIC_ARN, ''}
    USER_POOL_ID:
      Ref: CognitoUserPool
    USER_POOL_CLIENT_ID:
      Ref: CognitoUserPoolClient
    RESILIENCE_METRICS_NAMESPACE: ${self:service}/${self:provider.stage}
    # AWS AppConfig (optional - for advanced personalization features)
    APP_CONFIG_APPLICATION_ID: ${env:APP_CONFIG_APPLICATION_ID, ''}
    APP_CONFIG_ENVIRONMENT_ID: ${env:APP_CONFIG_ENVIRONMENT_ID, ''}
    APP_CONFIG_PROFILE_ID: ${env:APP_CONFIG_PROFILE_ID, ''}
    # Secretos administrados v√≠a AWS Systems Manager Parameter Store
    SENTRY_DSN: ${ssm:/sistema-gestion/${self:provider.stage}/sentry-dsn, ''}
    SENTRY_TRACES_SAMPLE_RATE: ${ssm:/sistema-gestion/${self:provider.stage}/sentry-traces-sample-rate, env:SENTRY_TRACES_SAMPLE_RATE, '0'}
    SENTRY_RELEASE: ${ssm:/sistema-gestion/${self:provider.stage}/sentry-release, env:SENTRY_RELEASE, ''}

# === PACKAGE CONFIGURATION ===
package:
  individually: false
  patterns:
    # Include
    - 'src/**'
    - 'package.json'
    - 'package-lock.json'
    
    # Exclude development files
    - '!.git/**'
    - '!.github/**'
    - '!.vscode/**'
    - '!.idea/**'
    - '!.serverless/**'
    - '!.dynamodb/**'
    
    # Exclude documentation
    - '!*.md'
    - '!docs/**'
    - '!README*'
    - '!CHANGELOG*'
    - '!LICENSE*'
    
    # Exclude tests and coverage
    - '!tests/**'
    - '!test/**'
    - '!__tests__/**'
    - '!coverage/**'
    - '!.nyc_output/**'
    - '!jest.config.js'
    
    # Exclude logs and temporary files
    - '!*.log'
    - '!logs/**'
    - '!tmp/**'
    - '!temp/**'
    
    # Exclude environment files
    - '!.env*'
    - '!.env.*.local'
    
    # Exclude build artifacts
    - '!dist/**'
    - '!build/**'
    - '!*.zip'
    - '!*.tar.gz'
    
    # Exclude CI/CD files
    - '!.travis.yml'
    - '!.gitlab-ci.yml'
    - '!azure-pipelines.yml'
    - '!circle.yml'
    
    # Exclude editor configs
    - '!.editorconfig'
    - '!.eslintrc*'
    - '!.prettierrc*'
    - '!tsconfig.json'

functions: ${file(serverless_extensions/functions.yml)}

resources: ${file(serverless_extensions/resources.yml)}