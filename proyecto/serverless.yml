service: sistema-gestion-espacios

frameworkVersion: '4'

custom:
  configValidationMode: warn
  
  # === FRONTEND DEPLOYMENT CONFIGURATION ===
  client:
    bucketName: ${self:service}-frontend-${self:provider.stage}
    distributionFolder: ../frontend/out
    indexDocument: index.html
    errorDocument: 404.html
    region: ${self:provider.region}
    createDistribution: true
    manageResources: false
    uploadConcurrency: 5
  
  # === SPLIT STACKS FOR LARGE DEPLOYMENTS ===
  splitStacks:
    nested: true
    perFunction: false
    perType: true
    stackType:
      AWS::ApiGatewayV2::Api: false
      AWS::ApiGatewayV2::Stage: false
      AWS::CloudFormation::Stack: false
  
  # === ENVIRONMENT-SPECIFIC SETTINGS ===
  stages:
    dev:
      logLevel: INFO
      tracing: false
      memorySize: 256
      nodeEnv: development
    staging:
      logLevel: WARN
      tracing: true
      memorySize: 512
      nodeEnv: staging
    prod:
      logLevel: ERROR
      tracing: true
      memorySize: 1024
      nodeEnv: production
  
  # === AUTOMATION HOOKS ===
  scriptable:
    hooks:
      # PRE-DEPLOYMENT: Setup infrastructure (comment out if AWS credentials not available)
      # before:aws:deploy:deploy:createStack:
      #   - echo "==> Deploying base infrastructure..."
      #   - node ../infrastructure/deploy-infrastructure.js ${self:provider.stage}
      
      # POST-DEPLOYMENT: Frontend build, upload and seeding
      after:deploy:deploy:
        - echo "==> Preparing frontend..."
        - cd ../frontend && npm ci
        - STACK_NAME=${self:service}-${self:provider.stage}; API_URL=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='HttpApiUrl'].OutputValue" --output text 2>/dev/null); WS_URL=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs[?OutputKey=='WebSocketUrl'].OutputValue" --output text 2>/dev/null); cd ../frontend && printf "NEXT_PUBLIC_API_URL=%s\nNEXT_PUBLIC_WS_URL=%s\nNEXT_PUBLIC_STAGE=%s\nNEXT_PUBLIC_AWS_REGION=%s\n" "$API_URL" "$WS_URL" "${self:provider.stage}" "${self:provider.region}" > .env.production.local
        - cd ../frontend && npm run build
        - cd ../frontend && npm run export
        - echo "==> Uploading frontend to S3..."
        - npx serverless client deploy
        - echo "==> Seeding database..."
        - DYNAMODB_TABLE=${self:service}-${self:provider.stage}-main node scripts/seed-dynamodb.js --stage ${self:provider.stage} --yes
        - echo "==> Running chaos engineering smoke tests..."
        - cd ../chaos-engineering && npm ci && npm run smoke
      
      # CLEANUP
      before:remove:remove:
        - echo "==> Removing frontend assets..."
        - npx serverless client remove

plugins:
  - serverless-finch
  - serverless-plugin-split-stacks
  - serverless-scriptable-plugin

provider:
  name: aws
  runtime: nodejs22.x
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  httpApi:
    authorizers:
      cognitoJwt:
        type: jwt
        identitySource: '$request.header.Authorization'
        issuerUrl:
          Fn::Sub: https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}
        audience:
          - { Ref: CognitoUserPoolClient }
  environment:
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
    AWS_REGION: ${self:provider.region}
    REGION: ${self:provider.region}
    STAGE: ${self:provider.stage}
    NODE_ENV: ${self:custom.stages.${self:provider.stage}.nodeEnv}
    DYNAMODB_TABLE: ${self:service}-${self:provider.stage}-main
    MAIN_TABLE: ${self:service}-${self:provider.stage}-main
    CONNECTIONS_TABLE: ${self:service}-${self:provider.stage}-connections
    CIRCUIT_STATE_TABLE: ${self:service}-${self:provider.stage}-circuit-state
    HTTP_API_URL:
      Fn::Sub: "https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com"
    WEBSOCKET_ENDPOINT:
      Fn::Sub: "https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${self:provider.stage}"
    MAIN_QUEUE_URL:
      Ref: MainQueue
    SNS_TOPIC_ARN:
      Ref: SpaceNotificationsTopic
    SNS_ALERTS_TOPIC_ARN:
      Ref: SystemAlertsTopic
    SNS_ADMIN_TOPIC_ARN:
      Ref: AdminNotificationsTopic
    SYSTEM_ALERTS_TOPIC:
      Ref: SystemAlertsTopic
    SNS_PERSONALIZATION_TOPIC_ARN: ${env:SNS_PERSONALIZATION_TOPIC_ARN, ''}
    USER_POOL_ID:
      Ref: CognitoUserPool
    USER_POOL_CLIENT_ID:
      Ref: CognitoUserPoolClient
    RESILIENCE_METRICS_NAMESPACE: ${self:service}/${self:provider.stage}
    SENTRY_DSN: ${env:SENTRY_DSN, ''}
    SENTRY_TRACES_SAMPLE_RATE: ${env:SENTRY_TRACES_SAMPLE_RATE, '0'}
    SENTRY_RELEASE: ${env:SENTRY_RELEASE, ''}

functions: ${file(serverless_extensions/functions.yml)}

resources: ${file(serverless_extensions/resources.yml)}