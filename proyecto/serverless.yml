service: sistema-gestion-espacios

frameworkVersion: '4'

custom:
  configValidationMode: warn
  
  # === FRONTEND DEPLOYMENT CONFIGURATION ===
  client:
    bucketName: ${self:service}-frontend-${self:provider.stage}
    distributionFolder: ../frontend/out
    indexDocument: index.html
    errorDocument: 404.html
    region: ${self:provider.region}
    createDistribution: true
    manageResources: false
    uploadConcurrency: 5
  
  # === SPLIT STACKS FOR LARGE DEPLOYMENTS ===
  splitStacks:
    nested: true
    perFunction: false
    perType: true
    stackType:
      AWS::ApiGatewayV2::Api: false
      AWS::ApiGatewayV2::Stage: false
      AWS::CloudFormation::Stack: false
  
  # === ENVIRONMENT-SPECIFIC SETTINGS ===
  stages:
    dev:
      logLevel: INFO
      tracing: false
      memorySize: 256
    staging:
      logLevel: WARN
      tracing: true
      memorySize: 512
    prod:
      logLevel: ERROR
      tracing: true
      memorySize: 1024
  
  # === AUTOMATION HOOKS ===
  scriptable:
    hooks:
      # PRE-DEPLOYMENT: Setup infrastructure (comment out if AWS credentials not available)
      # before:aws:deploy:deploy:createStack:
      #   - echo "==> Deploying base infrastructure..."
      #   - node ../infrastructure/deploy-infrastructure.js ${self:provider.stage}
      
      # FRONTEND BUILD & DEPLOYMENT
      after:aws:deploy:deploy:checkForChanges:
        - echo "==> Building frontend..."
        - cd ../frontend && npm ci
        - echo "==> Injecting environment variables..."
        - cd ../frontend && echo "NEXT_PUBLIC_API_URL=https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com" > .env.production.local
        - cd ../frontend && echo "NEXT_PUBLIC_WS_URL=wss://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${self:provider.stage}" >> .env.production.local
        - cd ../frontend && echo "NEXT_PUBLIC_STAGE=${self:provider.stage}" >> .env.production.local
        - cd ../frontend && echo "NEXT_PUBLIC_AWS_REGION=${self:provider.region}" >> .env.production.local
        - cd ../frontend && npm run build
        - cd ../frontend && npm run export
      
      # POST-DEPLOYMENT: Frontend upload and seeding
      after:deploy:deploy:
        - echo "==> Uploading frontend to S3..."
        - npx serverless client deploy
        - echo "==> Seeding database..."
        - DYNAMODB_TABLE=${self:service}-${self:provider.stage}-main node scripts/seed-dynamodb.js --stage ${self:provider.stage} --yes
        - echo "==> Running chaos engineering smoke tests..."
        - cd ../chaos-engineering && npm ci && npm run smoke
      
      # CLEANUP
      before:remove:remove:
        - echo "==> Removing frontend assets..."
        - npx serverless client remove

plugins:
  - serverless-finch
  - serverless-plugin-split-stacks
  - serverless-scriptable-plugin

provider:
  name: aws
  runtime: nodejs22.x
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}

functions: ${file(serverless_extensions/functions.yml)}

resources: ${file(serverless_extensions/resources.yml)}