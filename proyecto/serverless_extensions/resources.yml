Resources:
  # === FRONTEND S3 BUCKET ===
  FrontendBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: ${self:service}-frontend-${self:provider.stage}-v3
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: index.html
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: Environment
          Value: ${self:provider.stage}
        - Key: Project
          Value: ${self:service}

  # CloudFront Origin Access Identity (OAI) - Permite solo a CloudFront acceder a S3
  CloudFrontOriginAccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: !Sub "OAI for ${self:service}-${self:provider.stage} frontend bucket"

  # S3 Bucket Policy - SOLO permite acceso desde CloudFront (NO público)
  # Incluye controles de seguridad para producción
  FrontendBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Statement:
          # Permite solo a CloudFront leer objetos
          - Sid: CloudFrontReadForGetBucketObjects
            Effect: Allow
            Principal:
              CanonicalUser: !GetAtt CloudFrontOriginAccessIdentity.S3CanonicalUserId
            Action: s3:GetObject
            Resource: !Sub "${FrontendBucket.Arn}/*"
          
          # Deniega explícitamente tráfico HTTP no seguro
          - Sid: DenyInsecureTransport
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !Sub "${FrontendBucket.Arn}/*"
              - !GetAtt FrontendBucket.Arn
            Condition:
              Bool:
                "aws:SecureTransport": "false"
          
          # Deniega acceso público directo (backup de seguridad)
          - Sid: DenyPublicAccess
            Effect: Deny
            Principal: "*"
            Action:
              - "s3:GetObject"
              - "s3:PutObject"
            Resource: !Sub "${FrontendBucket.Arn}/*"
            Condition:
              StringNotEquals:
                "aws:userid": !GetAtt CloudFrontOriginAccessIdentity.S3CanonicalUserId

  # Web Application Firewall (WAF) para CloudFront - CRÍTICO para producción
  WAFWebACL:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: ${self:service}-${self:provider.stage}-waf
      Scope: CLOUDFRONT  # WAF para CloudFront debe estar en CLOUDFRONT scope
      Description: WAF rules to protect frontend application
      DefaultAction:
        Allow: {}
      Rules:
        # Protección contra SQL Injection
        - Name: AWSManagedRulesSQLiRuleSet
          Priority: 0
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesSQLiRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: SQLiRuleSetMetric
        
        # Protección contra XSS
        - Name: AWSManagedRulesKnownBadInputsRuleSet
          Priority: 1
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesKnownBadInputsRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: KnownBadInputsMetric
        
        # Protección contra ataques comunes (OWASP Top 10)
        - Name: AWSManagedRulesCommonRuleSet
          Priority: 2
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesCommonRuleSet
              ExcludedRules: []
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: CommonRuleSetMetric
        
        # Rate limiting - Protección contra DDoS L7 y scraping
        - Name: RateLimitRule
          Priority: 3
          Action:
            Block:
              CustomResponse:
                ResponseCode: 429
          Statement:
            RateBasedStatement:
              Limit: 2000  # 2000 requests por 5 minutos por IP
              AggregateKeyType: IP
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: RateLimitMetric
        
        # Geo-blocking (opcional - descomentar si solo opera en regiones específicas)
        # - Name: GeoBlockingRule
        #   Priority: 4
        #   Action:
        #     Block: {}
        #   Statement:
        #     NotStatement:
        #       Statement:
        #         GeoMatchStatement:
        #           CountryCodes:
        #             - US  # United States
        #             - CA  # Canada
        #             - MX  # Mexico
        #             - CR  # Costa Rica
        #             # Agregar países permitidos según mercado objetivo
        #   VisibilityConfig:
        #     SampledRequestsEnabled: true
        #     CloudWatchMetricsEnabled: true
        #     MetricName: GeoBlockingMetric
      
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: ${self:service}-${self:provider.stage}-waf-metric

  # CloudFront Distribution - Configuración production-ready con seguridad avanzada
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    DependsOn: WAFWebACL
    Properties:
      DistributionConfig:
        # Configuración del origen S3 con OAI
        Origins:
          - DomainName: !GetAtt FrontendBucket.RegionalDomainName
            Id: S3Origin
            S3OriginConfig:
              OriginAccessIdentity: !Sub "origin-access-identity/cloudfront/${CloudFrontOriginAccessIdentity}"
            ConnectionAttempts: 3
            ConnectionTimeout: 10
            OriginShield:
              Enabled: true
              OriginShieldRegion: !Ref AWS::Region
        
        Enabled: true
        Comment: !Sub "${self:service}-${self:provider.stage} Frontend Distribution"
        DefaultRootObject: index.html
        HttpVersion: http2and3  # HTTP/2 y HTTP/3 para mejor performance
        IPV6Enabled: true
        
        # Configuración de caché por defecto
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https  # Forzar HTTPS
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
            - OPTIONS
          Compress: true  # Compresión automática
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # Managed-CachingOptimized
          OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf  # Managed-CORS-S3Origin
          ResponseHeadersPolicyId: !Ref CloudFrontResponseHeadersPolicy
        
        # Price class optimizado para costos vs performance
        PriceClass: PriceClass_100  # Usar PriceClass_All para producción global
        
        # Manejo de errores SPA
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 300
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 300
        
        # Logging para auditoría y compliance
        Logging:
          Bucket: !GetAtt CloudFrontLogBucket.DomainName
          IncludeCookies: false
          Prefix: cloudfront-logs/
        
        # Asociar WAF WebACL
        WebACLId: !GetAtt WAFWebACL.Arn
        
        # Restricciones de visualización (opcional para contenido premium)
        # ViewerCertificate:
        #   CloudFrontDefaultCertificate: true
        #   # Para dominio personalizado con SSL:
        #   # AcmCertificateArn: !Ref SSLCertificate
        #   # SslSupportMethod: sni-only
        #   # MinimumProtocolVersion: TLSv1.2_2021
        


  # Response Headers Policy - Headers de seguridad HTTP
  CloudFrontResponseHeadersPolicy:
    Type: AWS::CloudFront::ResponseHeadersPolicy
    Properties:
      ResponseHeadersPolicyConfig:
        Name: ${self:service}-${self:provider.stage}-security-headers
        Comment: Security headers for production application
        
        SecurityHeadersConfig:
          # Strict-Transport-Security (HSTS)
          StrictTransportSecurity:
            AccessControlMaxAgeSec: 63072000  # 2 años
            IncludeSubdomains: true
            Preload: true
            Override: true
          
          # X-Content-Type-Options
          ContentTypeOptions:
            Override: true
          
          # X-Frame-Options (protección contra clickjacking)
          FrameOptions:
            FrameOption: DENY
            Override: true
          
          # X-XSS-Protection
          XSSProtection:
            ModeBlock: true
            Protection: true
            Override: true
          
          # Referrer-Policy
          ReferrerPolicy:
            ReferrerPolicy: strict-origin-when-cross-origin
            Override: true
          
          # Content-Security-Policy (CSP) - Crítico para prevenir XSS
          ContentSecurityPolicy:
            ContentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://apis.google.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://*.execute-api.${AWS::Region}.amazonaws.com wss://*.execute-api.${AWS::Region}.amazonaws.com; frame-ancestors 'none'; base-uri 'self'; form-action 'self'"
            Override: true
        
        # CORS configuration
        CorsConfig:
          AccessControlAllowOrigins:
            Items:
              - "*"  # Will be configured after deployment to avoid circular dependency
          AccessControlAllowHeaders:
            Items:
              - "*"
          AccessControlAllowMethods:
            Items:
              - GET
              - HEAD
              - OPTIONS
          AccessControlAllowCredentials: false
          OriginOverride: true
        
        # Custom headers adicionales
        CustomHeadersConfig:
          Items:
            - Header: X-Application-Version
              Value: ${self:provider.stage}
              Override: true
            - Header: Permissions-Policy
              Value: "geolocation=(), microphone=(), camera=()"
              Override: true

  # S3 Bucket para logs de CloudFront - Compliance y auditoría
  CloudFrontLogBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${self:service}-${self:provider.stage}-cloudfront-logs"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      # CloudFront logging requires ACL access - different from main bucket
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: true
        IgnorePublicAcls: false
        RestrictPublicBuckets: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: 90  # Retener logs por 90 días
            Transitions:
              - TransitionInDays: 30
                StorageClass: STANDARD_IA
              - TransitionInDays: 60
                StorageClass: GLACIER
      Tags:
        - Key: Purpose
          Value: CloudFront Access Logs
        - Key: Compliance
          Value: Required

  # CloudWatch Alarm para WAF - Monitoreo de ataques
  WAFBlockedRequestsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: ${self:service}-${self:provider.stage}-waf-blocked-requests
      AlarmDescription: Alert when WAF blocks high volume of requests
      MetricName: BlockedRequests
      Namespace: AWS/WAFV2
      Statistic: Sum
      Period: 300  # 5 minutos
      EvaluationPeriods: 2
      Threshold: 100  # Más de 100 requests bloqueadas en 10 minutos
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: Rule
          Value: ALL
        - Name: WebACL
          Value: ${self:service}-${self:provider.stage}-waf
      AlarmActions:
        - !Ref SystemAlertsTopic
      TreatMissingData: notBreaching

  # CloudWatch Alarm para CloudFront - Monitoreo de errores
  CloudFrontErrorRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: ${self:service}-${self:provider.stage}-cloudfront-error-rate
      AlarmDescription: Alert when CloudFront error rate is high
      MetricName: 5xxErrorRate
      Namespace: AWS/CloudFront
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 5  # Más de 5% de errores 5xx
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: DistributionId
          Value: !Ref CloudFrontDistribution
      AlarmActions:
        - !Ref SystemAlertsTopic
      TreatMissingData: notBreaching

  # === VPC INFRASTRUCTURE ===
  ProjectVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: ${self:service}-${self:provider.stage}-vpc

  # Internet Gateway
  ProjectIGW:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: ${self:service}-${self:provider.stage}-igw

  AttachIGW:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: { Ref: ProjectIGW }
      VpcId: { Ref: ProjectVPC }

  # Public Subnets
  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: { Ref: ProjectVPC }
      CidrBlock: 10.0.0.0/24
      AvailabilityZone: !Select [0, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: ${self:service}-${self:provider.stage}-public-a

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: { Ref: ProjectVPC }
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [1, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: ${self:service}-${self:provider.stage}-public-b

  # Private Subnets for Lambda
  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: { Ref: ProjectVPC }
      CidrBlock: 10.0.10.0/24
      AvailabilityZone: !Select [0, !GetAZs ""]
      Tags:
        - Key: Name
          Value: ${self:service}-${self:provider.stage}-private-a

  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: { Ref: ProjectVPC }
      CidrBlock: 10.0.11.0/24
      AvailabilityZone: !Select [1, !GetAZs ""]
      Tags:
        - Key: Name
          Value: ${self:service}-${self:provider.stage}-private-b

  # NAT Gateway (optional, for Lambda in VPC)
  NatEip:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: { Fn::GetAtt: [NatEip, AllocationId] }
      SubnetId: { Ref: PublicSubnetA }
      Tags:
        - Key: Name
          Value: ${self:service}-${self:provider.stage}-nat

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: { Ref: ProjectVPC }
      Tags:
        - Key: Name
          Value: ${self:service}-${self:provider.stage}-public-rt

  PublicRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: { Ref: PublicRouteTable }
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: { Ref: ProjectIGW }

  PublicSubnetAAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: { Ref: PublicSubnetA }
      RouteTableId: { Ref: PublicRouteTable }

  PublicSubnetBAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: { Ref: PublicSubnetB }
      RouteTableId: { Ref: PublicRouteTable }

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: { Ref: ProjectVPC }
      Tags:
        - Key: Name
          Value: ${self:service}-${self:provider.stage}-private-rt

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: { Ref: PrivateRouteTable }
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: { Ref: NatGateway }

  PrivateSubnetAAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: { Ref: PrivateSubnetA }
      RouteTableId: { Ref: PrivateRouteTable }

  PrivateSubnetBAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: { Ref: PrivateSubnetB }
      RouteTableId: { Ref: PrivateRouteTable }

  # Security Groups
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions
      VpcId: { Ref: ProjectVPC }
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: ${self:service}-${self:provider.stage}-lambda-sg

  # === BACKEND INFRASTRUCTURE ===

  # === BACKEND INFRASTRUCTURE ===
  # Main DynamoDB Table
  MainDynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ${self:service}-${self:provider.stage}-main
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true

  # WebSocket Connections Table
  WebSocketConnectionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ${self:service}-${self:provider.stage}-connections
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: connectionId
          AttributeType: S
        - AttributeName: clientId
          AttributeType: S
        - AttributeName: status
          AttributeType: S
      KeySchema:
        - AttributeName: connectionId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: ClientIdIndex
          KeySchema:
            - AttributeName: clientId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: StatusIndex
          KeySchema:
            - AttributeName: status
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  # Circuit Breaker State Table
  CircuitStateTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ${self:service}-${self:provider.stage}-circuit-state
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: serviceName
          AttributeType: S
      KeySchema:
        - AttributeName: serviceName
          KeyType: HASH

  # Idempotency Table for tracking completed operations
  IdempotencyTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ${self:service}-${self:provider.stage}-idempotency
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: idempotencyKey
          AttributeType: S
      KeySchema:
        - AttributeName: idempotencyKey
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Purpose
          Value: Idempotency tracking for critical operations
        - Key: TTL
          Value: 24 hours default

  # === MESSAGING INFRASTRUCTURE ===
  # Main Processing Queue
  MainQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: ${self:service}-${self:provider.stage}-main-queue
      VisibilityTimeout: 300
      MessageRetentionPeriod: 1209600
      RedrivePolicy:
        deadLetterTargetArn: { Fn::GetAtt: [DeadLetterQueue, Arn] }
        maxReceiveCount: 3

  # Dead Letter Queue
  DeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: ${self:service}-${self:provider.stage}-dlq
      MessageRetentionPeriod: 1209600

  # DevOps Automation Queue
  DevOpsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: ${self:service}-${self:provider.stage}-devops-queue
      VisibilityTimeout: 360
      MessageRetentionPeriod: 1209600
      RedrivePolicy:
        deadLetterTargetArn: { Fn::GetAtt: [DevOpsDeadLetterQueue, Arn] }
        maxReceiveCount: 3

  # DevOps Dead Letter Queue
  DevOpsDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: ${self:service}-${self:provider.stage}-devops-dlq
      MessageRetentionPeriod: 1209600
      Tags:
        - Key: Purpose
          Value: Dead letter queue for failed DevOps automation tasks

  # === SNS TOPICS ===
  SpaceNotificationsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: ${self:service}-${self:provider.stage}-space-notifications
      DisplayName: Space Management Notifications

  SystemAlertsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: ${self:service}-${self:provider.stage}-system-alerts
      DisplayName: System Alerts

  AdminNotificationsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: ${self:service}-${self:provider.stage}-admin-notifications
      DisplayName: Admin Notifications

  # === CLOUDWATCH ALARMS ===
  # Alarm for Main DLQ
  MainDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: ${self:service}-${self:provider.stage}-main-dlq-alarm
      AlarmDescription: Alert when messages arrive in Main Dead Letter Queue
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: QueueName
          Value: { Fn::GetAtt: [DeadLetterQueue, QueueName] }
      AlarmActions:
        - Ref: SystemAlertsTopic
      TreatMissingData: notBreaching

  # Alarm for DevOps DLQ
  DevOpsDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: ${self:service}-${self:provider.stage}-devops-dlq-alarm
      AlarmDescription: Alert when DevOps automation tasks fail and land in DLQ
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: QueueName
          Value: { Fn::GetAtt: [DevOpsDeadLetterQueue, QueueName] }
      AlarmActions:
        - Ref: SystemAlertsTopic
      TreatMissingData: notBreaching

  # === COGNITO AUTHENTICATION ===
  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: ${self:service}-${self:provider.stage}-pool
      UsernameAttributes:
        - email
      AutoVerifiedAttributes:
        - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
          RequireUppercase: true

  # Cognito User Groups for role-based permissions
  CognitoUserGroupAdmin:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: admin
      Description: Administrators with full system access
      UserPoolId: { Ref: CognitoUserPool }
      Precedence: 0

  CognitoUserGroupResponsable:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: responsable
      Description: Space managers with limited administrative access
      UserPoolId: { Ref: CognitoUserPool }
      Precedence: 1

  CognitoUserGroupUsuario:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: usuario
      Description: Regular users with basic access
      UserPoolId: { Ref: CognitoUserPool }
      Precedence: 2

  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: ${self:service}-${self:provider.stage}-client
      GenerateSecret: false
      UserPoolId: { Ref: CognitoUserPool }
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
      AccessTokenValidity: 60
      IdTokenValidity: 60
      RefreshTokenValidity: 30
      TokenValidityUnits:
        AccessToken: minutes
        IdToken: minutes
        RefreshToken: days
      ReadAttributes:
        - email
        - email_verified
        - name
        - family_name
        - phone_number
      WriteAttributes:
        - email
        - name
        - family_name
        - phone_number

  # === WEBSOCKET API ===
  WebSocketApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: ${self:service}-websocket-${self:provider.stage}
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: "$request.body.action"

  WebSocketStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: { Ref: WebSocketApi }
      StageName: ${self:provider.stage}
      AutoDeploy: true

  # === MONITORING & ALERTING ===
  # CloudWatch Dashboard
  MonitoringDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: ${self:service}-${self:provider.stage}-monitoring
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Duration", "FunctionName", "${self:service}-${self:provider.stage}-login"],
                  ["AWS/Lambda", "Errors", "FunctionName", "${self:service}-${self:provider.stage}-login"]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Lambda Performance"
              }
            }
          ]
        }

Outputs:
  # CloudFront Distribution
  CloudFrontDistributionId:
    Value: { Ref: CloudFrontDistribution }
    Export:
      Name: ${self:service}-${self:provider.stage}-cloudfront-id

  # Backend API
  FrontendApiUrl:
    Value: !Sub "https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com"
    Export:
      Name: ${self:service}-${self:provider.stage}-frontend-api-url

  FrontendWebSocketUrl:
    Value: !Sub "wss://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${self:provider.stage}"
    Export:
      Name: ${self:service}-${self:provider.stage}-frontend-websocket-url

  # Authentication
  CognitoUserPoolId:
    Value: { Ref: CognitoUserPool }
    Export:
      Name: ${self:service}-${self:provider.stage}-user-pool-id

  CognitoClientId:
    Value: { Ref: CognitoUserPoolClient }
    Export:
      Name: ${self:service}-${self:provider.stage}-client-id

  # Messaging Resources
  MainQueueUrl:
    Description: Main SQS Queue URL
    Value: { Ref: MainQueue }
    Export:
      Name: ${self:service}-${self:provider.stage}-main-queue-url

  SpaceNotificationsTopicArn:
    Description: Space Notifications SNS Topic ARN
    Value: { Ref: SpaceNotificationsTopic }
    Export:
      Name: ${self:service}-${self:provider.stage}-space-notifications-arn

  SystemAlertsTopicArn:
    Description: System Alerts SNS Topic ARN
    Value: { Ref: SystemAlertsTopic }
    Export:
      Name: ${self:service}-${self:provider.stage}-system-alerts-arn

  AdminNotificationsTopicArn:
    Description: Admin Notifications SNS Topic ARN
    Value: { Ref: AdminNotificationsTopic }
    Export:
      Name: ${self:service}-${self:provider.stage}-admin-notifications-arn

  # Database Resources
  MainTableName:
    Description: Main DynamoDB Table Name
    Value: { Ref: MainDynamoDBTable }
    Export:
      Name: ${self:service}-${self:provider.stage}-main-table-name

  ConnectionsTableName:
    Description: WebSocket Connections DynamoDB Table Name
    Value: { Ref: WebSocketConnectionsTable }
    Export:
      Name: ${self:service}-${self:provider.stage}-connections-table-name

  CircuitStateTableName:
    Description: Circuit Breaker State DynamoDB Table Name
    Value: { Ref: CircuitStateTable }
    Export:
      Name: ${self:service}-${self:provider.stage}-circuit-state-table-name

  IdempotencyTableName:
    Description: Idempotency DynamoDB Table Name
    Value: { Ref: IdempotencyTable }
    Export:
      Name: ${self:service}-${self:provider.stage}-idempotency-table-name
