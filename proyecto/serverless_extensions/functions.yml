# === AUTHENTICATION & AUTHORIZATION ===# === CORE AUTHENTICATION ===

authLogin:login:

  handler: src/handlers/cognitoAuth.login  handler: src/handlers/auth.login

  timeout: 10  timeout: 10

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}

  events:  events:

    - httpApi:    - httpApi:

        path: /auth/login        path: /auth/login

        method: post        method: post



authRefresh:register:

  handler: src/handlers/cognitoAuth.refresh  handler: src/handlers/auth.register

  timeout: 10  timeout: 10

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}

  events:  events:

    - httpApi:    - httpApi:

        path: /auth/refresh        path: /auth/register

        method: post        method: post



authLogout:refreshToken:

  handler: src/handlers/cognitoAuth.logout  handler: src/handlers/auth.refreshToken

  timeout: 10  timeout: 5

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}

  events:  events:

    - httpApi:    - httpApi:

        path: /auth/logout        path: /auth/refresh

        method: post        method: post

        authorizer:

          name: cognitoJwt# === HEALTH & MONITORING ===

healthCheck:

authMe:  handler: src/handlers/healthCheck.handler

  handler: src/handlers/cognitoAuth.me  timeout: 5

  timeout: 10  memorySize: 128

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}  events:

  events:    - httpApi:

    - httpApi:        path: /health

        path: /auth/me        method: get

        method: get

        authorizer:# === DEVOPS AUTOMATION AS LAMBDA ===

          name: cognitoJwtdevopsAutomation:

  handler: src/handlers/devops.automation

authPermissionsCatalog:  timeout: 30

  handler: src/handlers/authMetadata.getPermissionsCatalog  memorySize: 512

  timeout: 10  events:

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}    - schedule:

  events:        rate: rate(60 minutes)

    - httpApi:        description: "DevOps automation tasks"

        path: /auth/permissions    - httpApi:

        method: get        path: /devops/automation

        authorizer:        method: post

          name: cognitoJwt        authorizer:

          name: cognitoJwt

authRolesCatalog:  environment:

  handler: src/handlers/authMetadata.getRoleDesign    DEVOPS_MODE: automation

  timeout: 10

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}devopsAutomationWorker:

  events:  handler: src/handlers/devops.automationWorker

    - httpApi:  timeout: 300

        path: /auth/roles  memorySize: 512

        method: get  events:

        authorizer:    - sqs:

          name: cognitoJwt        arn: { Fn::GetAtt: [DevOpsQueue, Arn] }

        batchSize: 1

# === HEALTH & MONITORING ===  environment:

healthCheck:    DEVOPS_MODE: automation

  handler: src/handlers/healthCheck.handler    WORKER_MODE: true

  timeout: 5

  memorySize: 128devopsStatus:

  events:  handler: src/handlers/devops.status

    - httpApi:  timeout: 30

        path: /health  memorySize: 256

        method: get  events:

    - httpApi:

# === DEVOPS AUTOMATION ===        path: /devops/status

devopsAutomation:        method: get

  handler: src/handlers/devops.automation

  timeout: 30# === CHAOS ENGINEERING AS LAMBDA ===

  memorySize: 512chaosEngineering:

  events:  handler: src/handlers/chaos.resilience

    - schedule:  timeout: 30

        rate: rate(60 minutes)  memorySize: 256

        description: "DevOps automation tasks"  events:

    - httpApi:    - httpApi:

        path: /devops/automation        path: /chaos/test

        method: post        method: post

        authorizer:        authorizer:

          name: cognitoJwt          name: cognitoJwt

  environment:    - httpApi:

    DEVOPS_MODE: automation        path: /chaos/proxy

        method: any

devopsAutomationWorker:  environment:

  handler: src/handlers/devops.automationWorker    CHAOS_MODE: testing

  timeout: 300    CHAOS_TARGET_URL:

  memorySize: 512      Fn::Sub: "https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com"

  events:

    - sqs:# === CORE BUSINESS LOGIC ===

        arn: { Fn::GetAtt: [DevOpsQueue, Arn] }# Usuarios

        batchSize: 1getUsers:

  environment:  handler: src/handlers/usuarios.getUsers

    DEVOPS_MODE: automation  timeout: 10

    WORKER_MODE: true  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}

  events:

devopsStatus:    - httpApi:

  handler: src/handlers/devops.status        path: /users

  timeout: 30        method: get

  memorySize: 256        authorizer:

  events:          name: cognitoJwt

    - httpApi:

        path: /devops/statuscreateUser:

        method: get  handler: src/handlers/usuarios.createUser

        authorizer:  timeout: 10

          name: cognitoJwt  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}

  events:

# === CHAOS ENGINEERING ===    - httpApi:

chaosEngineering:        path: /users

  handler: src/handlers/chaos.resilience        method: post

  timeout: 30        authorizer:

  memorySize: 256          name: cognitoJwt

  events:

    - httpApi:# Espacios

        path: /chaos/testgetEspacios:

        method: post  handler: src/handlers/espacios.getEspacios

        authorizer:  timeout: 10

          name: cognitoJwt  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}

    - httpApi:  events:

        path: /chaos/proxy    - httpApi:

        method: any        path: /espacios

  environment:        method: get

    CHAOS_MODE: testing        authorizer:

    CHAOS_TARGET_URL:          name: cognitoJwt

      Fn::Sub: "https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com"

createEspacio:

# === CORE BUSINESS DOMAINS ===  handler: src/handlers/espacios.createEspacio

# Usuarios  timeout: 10

usuariosListar:  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}

  handler: src/handlers/usuarios.getUsuarios  events:

  timeout: 10    - httpApi:

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}        path: /espacios

  events:        method: post

    - httpApi:        authorizer:

        path: /usuarios          name: cognitoJwt

        method: get

        authorizer:# Reservas

          name: cognitoJwtgetReservas:

  handler: src/handlers/reservas.getReservas

usuariosConsultar:  timeout: 10

  handler: src/handlers/usuarios.getUsuario  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}

  timeout: 10  events:

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}    - httpApi:

  events:        path: /reservas

    - httpApi:        method: get

        path: /usuarios/{id}        authorizer:

        method: get          name: cognitoJwt

        authorizer:

          name: cognitoJwtcreateReserva:

  handler: src/handlers/reservas.createReserva

usuariosCrear:  timeout: 15

  handler: src/handlers/usuarios.createUsuario  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}

  timeout: 10  events:

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}    - httpApi:

  events:        path: /reservas

    - httpApi:        method: post

        path: /usuarios        authorizer:

        method: post          name: cognitoJwt

        authorizer:

          name: cognitoJwt# === WEBSOCKET REAL-TIME ===

websocketConnect:

usuariosActualizar:  handler: src/handlers/websocket.connect.connect

  handler: src/handlers/usuarios.updateUsuario  timeout: 10

  timeout: 10  memorySize: 256

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}  events:

  events:    - websocket:

    - httpApi:        route: $connect

        path: /usuarios/{id}

        method: putwebsocketDisconnect:

        authorizer:  handler: src/handlers/websocket.disconnect.disconnect

          name: cognitoJwt  timeout: 10

  memorySize: 256

usuariosEliminar:  events:

  handler: src/handlers/usuarios.deleteUsuario    - websocket:

  timeout: 10        route: $disconnect

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}

  events:websocketDefault:

    - httpApi:  handler: src/handlers/websocket.default.default

        path: /usuarios/{id}  timeout: 10

        method: delete  memorySize: 256

        authorizer:  events:

          name: cognitoJwt    - websocket:

        route: $default

usuariosToggleEstado:

  handler: src/handlers/usuarios.toggleUsuarioEstado# === QUEUE WORKERS ===

  timeout: 10queueWorker:

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}  handler: src/handlers/queueWorker.handler

  events:  timeout: 60

    - httpApi:  memorySize: 512

        path: /usuarios/{id}/toggle-estado  events:

        method: patch    - sqs:

        authorizer:        arn: { Fn::GetAtt: [MainQueue, Arn] }

          name: cognitoJwt        batchSize: 10

        maximumBatchingWindow: 5

usuariosPerfilActual:

  handler: src/handlers/usuarios.getPerfilActual# === SNS EVENT PROCESSORS ===

  timeout: 10notificationProcessor:

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}  handler: src/handlers/sns.handler

  events:  timeout: 30

    - httpApi:  memorySize: 256

        path: /usuarios/perfil  events:

        method: get    - sns:

        authorizer:        arn: { Ref: SpaceNotificationsTopic }

          name: cognitoJwt        topicName: ${self:service}-${self:provider.stage}-space-notifications

    - sns:

usuariosActualizarPerfil:        arn: { Ref: SystemAlertsTopic }

  handler: src/handlers/usuarios.updatePerfilActual        topicName: ${self:service}-${self:provider.stage}-system-alerts

  timeout: 10

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}# === MISSING BUSINESS HANDLERS ===

  events:# Dashboard Analytics

    - httpApi:getDashboardMetrics:

        path: /usuarios/perfil  handler: src/handlers/dashboard.getDashboardMetrics

        method: put  timeout: 29

        authorizer:  events:

          name: cognitoJwt    - http:

        path: /dashboard/metrics

usuariosCambioPassword:        method: get

  handler: src/handlers/usuarios.cambiarPassword        cors: true

  timeout: 10

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}getDashboardStats:

  events:  handler: src/handlers/dashboard.getDashboardStats

    - httpApi:  timeout: 29

        path: /usuarios/cambiar-password  events:

        method: post    - http:

        authorizer:        path: /dashboard/stats

          name: cognitoJwt        method: get

        cors: true

# Espacios

espaciosListar:# Responsables Management

  handler: src/handlers/espacios.getEspaciosgetResponsables:

  timeout: 10  handler: src/handlers/responsables.getResponsables

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}  timeout: 29

  events:  events:

    - httpApi:    - http:

        path: /espacios        path: /responsables

        method: get        method: get

        authorizer:        cors: true

          name: cognitoJwt

getResponsable:

espaciosConsultar:  handler: src/handlers/responsables.getResponsable

  handler: src/handlers/espacios.getEspacio  timeout: 29

  timeout: 10  events:

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}    - http:

  events:        path: /responsables/{id}

    - httpApi:        method: get

        path: /espacios/{id}        cors: true

        method: get

        authorizer:createResponsable:

          name: cognitoJwt  handler: src/handlers/responsables.createResponsable

  timeout: 29

espaciosCrear:  events:

  handler: src/handlers/espacios.createEspacio    - http:

  timeout: 10        path: /responsables

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}        method: post

  events:        cors: true

    - httpApi:

        path: /espaciosupdateResponsable:

        method: post  handler: src/handlers/responsables.updateResponsable

        authorizer:  timeout: 29

          name: cognitoJwt  events:

    - http:

espaciosActualizar:        path: /responsables/{id}

  handler: src/handlers/espacios.updateEspacio        method: put

  timeout: 10        cors: true

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}

  events:deleteResponsable:

    - httpApi:  handler: src/handlers/responsables.deleteResponsable

        path: /espacios/{id}  timeout: 29

        method: put  events:

        authorizer:    - http:

          name: cognitoJwt        path: /responsables/{id}

        method: delete

espaciosEliminar:        cors: true

  handler: src/handlers/espacios.deleteEspacio

  timeout: 10# Zonas Management

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}getZonas:

  events:  handler: src/handlers/zonas.getZonas

    - httpApi:  timeout: 29

        path: /espacios/{id}  events:

        method: delete    - http:

        authorizer:        path: /zonas

          name: cognitoJwt        method: get

        cors: true

espaciosEstadisticas:

  handler: src/handlers/espacios.getEstadisticasEspaciosgetZona:

  timeout: 10  handler: src/handlers/zonas.getZona

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}  timeout: 29

  events:  events:

    - httpApi:    - http:

        path: /espacios/estadisticas        path: /zonas/{id}

        method: get        method: get

        authorizer:        cors: true

          name: cognitoJwt

createZona:

# Reservas  handler: src/handlers/zonas.createZona

reservasListar:  timeout: 29

  handler: src/handlers/reservas.getReservas  events:

  timeout: 10    - http:

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}        path: /zonas

  events:        method: post

    - httpApi:        cors: true

        path: /reservas

        method: getupdateZona:

        authorizer:  handler: src/handlers/zonas.updateZona

          name: cognitoJwt  timeout: 29

  events:

reservasConsultar:    - http:

  handler: src/handlers/reservas.getReserva        path: /zonas/{id}

  timeout: 10        method: put

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}        cors: true

  events:

    - httpApi:deleteZona:

        path: /reservas/{id}  handler: src/handlers/zonas.deleteZona

        method: get  timeout: 29

        authorizer:  events:

          name: cognitoJwt    - http:

        path: /zonas/{id}

reservasCrear:        method: delete

  handler: src/handlers/reservas.createReserva        cors: true

  timeout: 15

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}# DynamoDB Stream Processor (CRITICAL)

  events:dynamoStreamProcessor:

    - httpApi:  handler: src/handlers/dynamoStreamProcessor.handler

        path: /reservas  timeout: 60

        method: post  memorySize: 512

        authorizer:  events:

          name: cognitoJwt    - stream:

        type: dynamodb

reservasActualizar:        arn: { Fn::GetAtt: [MainDynamoDBTable, StreamArn] }

  handler: src/handlers/reservas.updateReserva        batchSize: 10

  timeout: 15        startingPosition: LATEST

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}        filterPatterns:

  events:          - eventName: [INSERT, MODIFY, REMOVE]

    - httpApi:

        path: /reservas/{id}# Alternative Cognito Authentication

        method: putcognitoLogin:

        authorizer:  handler: src/handlers/cognitoAuth.login

          name: cognitoJwt  timeout: 29

  events:

reservasCancelar:    - http:

  handler: src/handlers/reservas.cancelReserva        path: /auth/cognito/login

  timeout: 15        method: post

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}        cors: true

  events:

    - httpApi:cognitoRegister:

        path: /reservas/{id}/cancel  handler: src/handlers/cognitoAuth.register

        method: patch  timeout: 29

        authorizer:  events:

          name: cognitoJwt    - http:

        path: /auth/cognito/register

reservasEliminar:        method: post

  handler: src/handlers/reservas.deleteReserva        cors: true

  timeout: 15

  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}cognitoRefresh:

  events:  handler: src/handlers/cognitoAuth.refreshToken

    - httpApi:  timeout: 29

        path: /reservas/{id}  events:

        method: delete    - http:

        authorizer:        path: /auth/cognito/refresh

          name: cognitoJwt        method: post

        cors: true

reservasEstadisticas:
  handler: src/handlers/reservas.getEstadisticasReservas
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /reservas/estadisticas
        method: get
        authorizer:
          name: cognitoJwt

# Responsables
responsablesListar:
  handler: src/handlers/responsables.getResponsables
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables
        method: get
        authorizer:
          name: cognitoJwt

responsablesConsultar:
  handler: src/handlers/responsables.getResponsable
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables/{id}
        method: get
        authorizer:
          name: cognitoJwt

responsablesCrear:
  handler: src/handlers/responsables.createResponsable
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables
        method: post
        authorizer:
          name: cognitoJwt

responsablesActualizar:
  handler: src/handlers/responsables.updateResponsable
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables/{id}
        method: put
        authorizer:
          name: cognitoJwt

responsablesEliminar:
  handler: src/handlers/responsables.deleteResponsable
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables/{id}
        method: delete
        authorizer:
          name: cognitoJwt

responsablesToggleEstado:
  handler: src/handlers/responsables.toggleResponsableEstado
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables/{id}/toggle-estado
        method: patch
        authorizer:
          name: cognitoJwt

responsablesPorArea:
  handler: src/handlers/responsables.getResponsablesPorArea
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables/area/{area}
        method: get
        authorizer:
          name: cognitoJwt

responsablesEspaciosAsignados:
  handler: src/handlers/responsables.getEspaciosAsignados
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables/{id}/espacios
        method: get
        authorizer:
          name: cognitoJwt

responsablesAsignarEspacios:
  handler: src/handlers/responsables.asignarEspacio
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables/{id}/asignar-espacios
        method: post
        authorizer:
          name: cognitoJwt

responsablesEstadisticas:
  handler: src/handlers/responsables.getEstadisticasResponsables
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables/estadisticas
        method: get
        authorizer:
          name: cognitoJwt

# Zonas
zonasListar:
  handler: src/handlers/zonas.getZonas
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas
        method: get
        authorizer:
          name: cognitoJwt

zonasConsultar:
  handler: src/handlers/zonas.getZona
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas/{id}
        method: get
        authorizer:
          name: cognitoJwt

zonasCrear:
  handler: src/handlers/zonas.createZona
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas
        method: post
        authorizer:
          name: cognitoJwt

zonasActualizar:
  handler: src/handlers/zonas.updateZona
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas/{id}
        method: put
        authorizer:
          name: cognitoJwt

zonasEliminar:
  handler: src/handlers/zonas.deleteZona
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas/{id}
        method: delete
        authorizer:
          name: cognitoJwt

zonasToggleEstado:
  handler: src/handlers/zonas.toggleZonaEstado
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas/{id}/toggle-estado
        method: patch
        authorizer:
          name: cognitoJwt

zonasPorPiso:
  handler: src/handlers/zonas.getZonasPorPiso
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas/piso/{piso}
        method: get
        authorizer:
          name: cognitoJwt

zonasEspacios:
  handler: src/handlers/zonas.getEspaciosZona
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas/{id}/espacios
        method: get
        authorizer:
          name: cognitoJwt

zonasEstadisticas:
  handler: src/handlers/zonas.getEstadisticasZonas
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas/estadisticas
        method: get
        authorizer:
          name: cognitoJwt

zonasPisosDisponibles:
  handler: src/handlers/zonas.getPisosDisponibles
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /pisos-disponibles
        method: get
        authorizer:
          name: cognitoJwt

zonasEdificiosDisponibles:
  handler: src/handlers/zonas.getEdificiosDisponibles
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /edificios-disponibles
        method: get
        authorizer:
          name: cognitoJwt

# Personalizaci√≥n SaaS
personalizationConfigGlobal:
  handler: src/handlers/personalization.getClientGlobalConfig
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/client/{clientId}/global
        method: get
        authorizer:
          name: cognitoJwt

personalizationUpdateGlobal:
  handler: src/handlers/personalization.updateClientGlobalConfig
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/client/{clientId}/global
        method: put
        authorizer:
          name: cognitoJwt

personalizationUserConfig:
  handler: src/handlers/personalization.getUserSpecificConfig
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/client/{clientId}/user/{userId}
        method: get
        authorizer:
          name: cognitoJwt

personalizationUpdateUserConfig:
  handler: src/handlers/personalization.updateUserSpecificConfig
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/client/{clientId}/user/{userId}
        method: put
        authorizer:
          name: cognitoJwt

personalizationCompleteConfig:
  handler: src/handlers/personalization.getCompleteUserConfig
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/client/{clientId}/user/{userId}/complete
        method: get
        authorizer:
          name: cognitoJwt

personalizationLoadExternal:
  handler: src/handlers/personalization.loadExternalConfig
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/client/{clientId}/load-external
        method: post
        authorizer:
          name: cognitoJwt

personalizationExport:
  handler: src/handlers/personalization.exportClientConfig
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/client/{clientId}/export
        method: get
        authorizer:
          name: cognitoJwt

personalizationClearCache:
  handler: src/handlers/personalization.clearConfigurationCache
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/cache/clear
        method: post
        authorizer:
          name: cognitoJwt

personalizationIndustryConfig:
  handler: src/handlers/personalization.getIndustryConfig
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/industries/{industry}/config
        method: get
        authorizer:
          name: cognitoJwt

# Dashboard Analytics
dashboardMetrics:
  handler: src/handlers/dashboard.getDashboardMetrics
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /dashboard/metrics
        method: get
        authorizer:
          name: cognitoJwt

dashboardStats:
  handler: src/handlers/dashboard.getDashboardStats
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /dashboard/stats
        method: get
        authorizer:
          name: cognitoJwt

# Real-time WebSocket endpoints
websocketConnect:
  handler: src/handlers/websocket.connect.connect
  timeout: 10
  memorySize: 256
  events:
    - websocket:
        route: $connect

websocketDisconnect:
  handler: src/handlers/websocket.disconnect.disconnect
  timeout: 10
  memorySize: 256
  events:
    - websocket:
        route: $disconnect

websocketDefault:
  handler: src/handlers/websocket.default.default
  timeout: 10
  memorySize: 256
  events:
    - websocket:
        route: $default

# Queue Workers & Streams
queueWorker:
  handler: src/handlers/queueWorker.handler
  timeout: 60
  memorySize: 512
  events:
    - sqs:
        arn: { Fn::GetAtt: [MainQueue, Arn] }
        batchSize: 10
        maximumBatchingWindow: 5

dynamoStreamProcessor:
  handler: src/handlers/dynamoStreamProcessor.handler
  timeout: 60
  memorySize: 512
  events:
    - stream:
        type: dynamodb
        arn: { Fn::GetAtt: [MainDynamoDBTable, StreamArn] }
        batchSize: 10
        startingPosition: LATEST
        filterPatterns:
          - eventName: [INSERT, MODIFY, REMOVE]

# Notifications
notificationProcessor:
  handler: src/handlers/sns.handler
  timeout: 30
  memorySize: 256
  events:
    - sns:
        arn: { Ref: SpaceNotificationsTopic }
        topicName: ${self:service}-${self:provider.stage}-space-notifications
    - sns:
        arn: { Ref: SystemAlertsTopic }
        topicName: ${self:service}-${self:provider.stage}-system-alerts
