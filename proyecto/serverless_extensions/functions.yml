# === AUTHENTICATION & AUTHORIZATION ===
authLogin:
  handler: src/handlers/cognitoAuth.login
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /auth/login
        method: post

authRefresh:
  handler: src/handlers/cognitoAuth.refresh
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /auth/refresh
        method: post

authLogout:
  handler: src/handlers/cognitoAuth.logout
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /auth/logout
        method: post
        authorizer:
          name: cognitoJwt

authMe:
  handler: src/handlers/cognitoAuth.me
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /auth/me
        method: get
        authorizer:
          name: cognitoJwt

authPermissionsCatalog:
  handler: src/handlers/authMetadata.getPermissionsCatalog
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /auth/permissions
        method: get
        authorizer:
          name: cognitoJwt

authRolesCatalog:
  handler: src/handlers/authMetadata.getRoleDesign
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /auth/roles
        method: get
        authorizer:
          name: cognitoJwt

# === HEALTH & MONITORING ===
healthCheck:
  handler: src/handlers/healthCheck.handler
  timeout: 5
  memorySize: 128
  events:
    - httpApi:
        path: /health
        method: get

# === DEVOPS AUTOMATION ===
devopsAutomation:
  handler: src/handlers/devops.automation
  timeout: 25
  memorySize: 512
  events:
    - schedule:
        rate: rate(60 minutes)
        description: "DevOps automation tasks"
    - httpApi:
        path: /devops/automation
        method: post
        authorizer:
          name: cognitoJwt
  environment:
    DEVOPS_MODE: automation

devopsAutomationWorker:
  handler: src/handlers/devops.automationWorker
  timeout: 300
  memorySize: 512
  events:
    - sqs:
        arn: { Fn::GetAtt: [DevOpsQueue, Arn] }
        batchSize: 5
        functionResponseType: ReportBatchItemFailures
  environment:
    DEVOPS_MODE: automation
    WORKER_MODE: true

devopsStatus:
  handler: src/handlers/devops.status
  timeout: 25
  memorySize: 256
  events:
    - httpApi:
        path: /devops/status
        method: get

# === CHAOS ENGINEERING ===
chaosEngineering:
  handler: src/handlers/chaos.resilience
  timeout: 25
  memorySize: 256
  events:
    - httpApi:
        path: /chaos/test
        method: post
        authorizer:
          name: cognitoJwt
    - httpApi:
        path: /chaos/proxy
        method: any
  environment:
    CHAOS_MODE: testing
    CHAOS_TARGET_URL:
      Fn::Sub: "https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com"

# === SYSTEM MONITORING & RESILIENCE ===
# FASE 1 - MEJORA 3: Dashboard de Circuit Breakers
circuitStatus:
  handler: src/api/system/circuitStatus.handler
  timeout: 10
  memorySize: 256
  events:
    - httpApi:
        path: /system/circuit-status
        method: get
        authorizer:
          name: cognitoJwt

# === CORE BUSINESS DOMAINS ===
# Usuarios
usuariosListar:
  handler: src/handlers/usuarios.getUsuarios
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /usuarios
        method: get
        authorizer:
          name: cognitoJwt

usuariosConsultar:
  handler: src/handlers/usuarios.getUsuario
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /usuarios/{id}
        method: get
        authorizer:
          name: cognitoJwt

usuariosCrear:
  handler: src/handlers/usuarios.createUsuario
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /usuarios
        method: post
        authorizer:
          name: cognitoJwt

usuariosActualizar:
  handler: src/handlers/usuarios.updateUsuario
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /usuarios/{id}
        method: put
        authorizer:
          name: cognitoJwt

usuariosEliminar:
  handler: src/handlers/usuarios.deleteUsuario
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /usuarios/{id}
        method: delete
        authorizer:
          name: cognitoJwt

usuariosToggleEstado:
  handler: src/handlers/usuarios.toggleUsuarioEstado
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /usuarios/{id}/toggle-estado
        method: patch
        authorizer:
          name: cognitoJwt

usuariosPerfilActual:
  handler: src/handlers/usuarios.getPerfilActual
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /usuarios/perfil
        method: get
        authorizer:
          name: cognitoJwt

usuariosActualizarPerfil:
  handler: src/handlers/usuarios.updatePerfilActual
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /usuarios/perfil
        method: put
        authorizer:
          name: cognitoJwt

usuariosCambioPassword:
  handler: src/handlers/usuarios.cambiarPassword
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /usuarios/cambiar-password
        method: post
        authorizer:
          name: cognitoJwt

# Espacios
espaciosListar:
  handler: src/handlers/espacios.getEspacios
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /espacios
        method: get
        authorizer:
          name: cognitoJwt

espaciosConsultar:
  handler: src/handlers/espacios.getEspacio
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /espacios/{id}
        method: get
        authorizer:
          name: cognitoJwt

espaciosCrear:
  handler: src/handlers/espacios.createEspacio
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /espacios
        method: post
        authorizer:
          name: cognitoJwt

espaciosActualizar:
  handler: src/handlers/espacios.updateEspacio
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /espacios/{id}
        method: put
        authorizer:
          name: cognitoJwt

espaciosEliminar:
  handler: src/handlers/espacios.deleteEspacio
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /espacios/{id}
        method: delete
        authorizer:
          name: cognitoJwt

espaciosEstadisticas:
  handler: src/handlers/espacios.getEstadisticasEspacios
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /espacios/estadisticas
        method: get
        authorizer:
          name: cognitoJwt

# Reservas
reservasListar:
  handler: src/handlers/reservas.getReservas
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /reservas
        method: get
        authorizer:
          name: cognitoJwt

reservasConsultar:
  handler: src/handlers/reservas.getReserva
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /reservas/{id}
        method: get
        authorizer:
          name: cognitoJwt

reservasCrear:
  handler: src/handlers/reservas.createReserva
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /reservas
        method: post
        authorizer:
          name: cognitoJwt

reservasActualizar:
  handler: src/handlers/reservas.updateReserva
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /reservas/{id}
        method: put
        authorizer:
          name: cognitoJwt

reservasCancelar:
  handler: src/handlers/reservas.cancelReserva
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /reservas/{id}/cancel
        method: patch
        authorizer:
          name: cognitoJwt

reservasEliminar:
  handler: src/handlers/reservas.deleteReserva
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /reservas/{id}
        method: delete
        authorizer:
          name: cognitoJwt

reservasEstadisticas:
  handler: src/handlers/reservas.getEstadisticasReservas
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /reservas/estadisticas
        method: get
        authorizer:
          name: cognitoJwt

# Responsables
responsablesListar:
  handler: src/handlers/responsables.getResponsables
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables
        method: get
        authorizer:
          name: cognitoJwt

responsablesConsultar:
  handler: src/handlers/responsables.getResponsable
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables/{id}
        method: get
        authorizer:
          name: cognitoJwt

responsablesCrear:
  handler: src/handlers/responsables.createResponsable
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables
        method: post
        authorizer:
          name: cognitoJwt

responsablesActualizar:
  handler: src/handlers/responsables.updateResponsable
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables/{id}
        method: put
        authorizer:
          name: cognitoJwt

responsablesEliminar:
  handler: src/handlers/responsables.deleteResponsable
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables/{id}
        method: delete
        authorizer:
          name: cognitoJwt

responsablesToggleEstado:
  handler: src/handlers/responsables.toggleResponsableEstado
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables/{id}/toggle-estado
        method: patch
        authorizer:
          name: cognitoJwt

responsablesPorArea:
  handler: src/handlers/responsables.getResponsablesPorArea
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables/area/{area}
        method: get
        authorizer:
          name: cognitoJwt

responsablesEspaciosAsignados:
  handler: src/handlers/responsables.getEspaciosAsignados
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables/{id}/espacios
        method: get
        authorizer:
          name: cognitoJwt

responsablesAsignarEspacios:
  handler: src/handlers/responsables.asignarEspacio
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables/{id}/asignar-espacios
        method: post
        authorizer:
          name: cognitoJwt

responsablesEstadisticas:
  handler: src/handlers/responsables.getEstadisticasResponsables
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /responsables/estadisticas
        method: get
        authorizer:
          name: cognitoJwt

# Zonas
zonasListar:
  handler: src/handlers/zonas.getZonas
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas
        method: get
        authorizer:
          name: cognitoJwt

zonasConsultar:
  handler: src/handlers/zonas.getZona
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas/{id}
        method: get
        authorizer:
          name: cognitoJwt

zonasCrear:
  handler: src/handlers/zonas.createZona
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas
        method: post
        authorizer:
          name: cognitoJwt

zonasActualizar:
  handler: src/handlers/zonas.updateZona
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas/{id}
        method: put
        authorizer:
          name: cognitoJwt

zonasEliminar:
  handler: src/handlers/zonas.deleteZona
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas/{id}
        method: delete
        authorizer:
          name: cognitoJwt

zonasToggleEstado:
  handler: src/handlers/zonas.toggleZonaEstado
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas/{id}/toggle-estado
        method: patch
        authorizer:
          name: cognitoJwt

zonasPorPiso:
  handler: src/handlers/zonas.getZonasPorPiso
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas/piso/{piso}
        method: get
        authorizer:
          name: cognitoJwt

zonasEspacios:
  handler: src/handlers/zonas.getEspaciosZona
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas/{id}/espacios
        method: get
        authorizer:
          name: cognitoJwt

zonasEstadisticas:
  handler: src/handlers/zonas.getEstadisticasZonas
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /zonas/estadisticas
        method: get
        authorizer:
          name: cognitoJwt

zonasPisosDisponibles:
  handler: src/handlers/zonas.getPisosDisponibles
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /pisos-disponibles
        method: get
        authorizer:
          name: cognitoJwt

zonasEdificiosDisponibles:
  handler: src/handlers/zonas.getEdificiosDisponibles
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /edificios-disponibles
        method: get
        authorizer:
          name: cognitoJwt

# Personalización SaaS
personalizationConfigGlobal:
  handler: src/handlers/personalization.getClientGlobalConfig
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/client/{clientId}/global
        method: get
        authorizer:
          name: cognitoJwt

personalizationUpdateGlobal:
  handler: src/handlers/personalization.updateClientGlobalConfig
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/client/{clientId}/global
        method: put
        authorizer:
          name: cognitoJwt

personalizationUserConfig:
  handler: src/handlers/personalization.getUserSpecificConfig
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/client/{clientId}/user/{userId}
        method: get
        authorizer:
          name: cognitoJwt

personalizationUpdateUserConfig:
  handler: src/handlers/personalization.updateUserSpecificConfig
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/client/{clientId}/user/{userId}
        method: put
        authorizer:
          name: cognitoJwt

personalizationCompleteConfig:
  handler: src/handlers/personalization.getCompleteUserConfig
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/client/{clientId}/user/{userId}/complete
        method: get
        authorizer:
          name: cognitoJwt

personalizationLoadExternal:
  handler: src/handlers/personalization.loadExternalConfig
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/client/{clientId}/load-external
        method: post
        authorizer:
          name: cognitoJwt

personalizationExport:
  handler: src/handlers/personalization.exportClientConfig
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/client/{clientId}/export
        method: get
        authorizer:
          name: cognitoJwt

personalizationClearCache:
  handler: src/handlers/personalization.clearConfigurationCache
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/cache/clear
        method: post
        authorizer:
          name: cognitoJwt

personalizationIndustryConfig:
  handler: src/handlers/personalization.getIndustryConfig
  timeout: 10
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /personalization/industries/{industry}/config
        method: get
        authorizer:
          name: cognitoJwt

# Dashboard Analytics
dashboardMetrics:
  handler: src/handlers/dashboard.getDashboardMetrics
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /dashboard/metrics
        method: get
        authorizer:
          name: cognitoJwt

dashboardStats:
  handler: src/handlers/dashboard.getDashboardStats
  timeout: 15
  memorySize: ${self:custom.stages.${self:provider.stage}.memorySize}
  events:
    - httpApi:
        path: /dashboard/stats
        method: get
        authorizer:
          name: cognitoJwt

# Real-time WebSocket endpoints
websocketConnect:
  handler: src/handlers/websocket.connect.connect
  timeout: 10
  memorySize: 256
  events:
    - websocket:
        route: $connect

websocketDisconnect:
  handler: src/handlers/websocket.disconnect.disconnect
  timeout: 10
  memorySize: 256
  events:
    - websocket:
        route: $disconnect

websocketDefault:
  handler: src/handlers/websocket.default.default
  timeout: 10
  memorySize: 256
  events:
    - websocket:
        route: $default

# Queue Workers & Streams
queueWorker:
  handler: src/handlers/queueWorker.handler
  timeout: 60
  memorySize: 512
  events:
    - sqs:
        arn: { Fn::GetAtt: [MainQueue, Arn] }
        batchSize: 10
        maximumBatchingWindow: 5

dynamoStreamProcessor:
  handler: src/handlers/dynamoStreamProcessor.handler
  timeout: 60
  memorySize: 512
  events:
    - stream:
        type: dynamodb
        arn: { Fn::GetAtt: [MainDynamoDBTable, StreamArn] }
        batchSize: 10
        startingPosition: LATEST
        filterPatterns:
          - eventName: [INSERT, MODIFY, REMOVE]

# Notifications
notificationProcessor:
  handler: src/handlers/sns.handler
  timeout: 30
  memorySize: 256
  events:
    - sns:
        arn: { Ref: SpaceNotificationsTopic }
        topicName: ${self:service}-${self:provider.stage}-space-notifications
    - sns:
        arn: { Ref: SystemAlertsTopic }
        topicName: ${self:service}-${self:provider.stage}-system-alerts
